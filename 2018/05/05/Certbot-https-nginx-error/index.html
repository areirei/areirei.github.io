<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Certbot部署配置HTTPS及nginx报错解决 · FullStackMan</title><meta name="description" content="Certbot nginx NoInstallationError"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/mylogo.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://areirei.github.io/atom.xml" title="FullStackMan"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/mylogo.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://kuaibao.qq.com/s/MEDIANEWSLIST?chlid=6121989" target="_blank" class="nav-list-link">KUAIBAO</a></li><li class="nav-list-item"><a href="https://github.com/areirei" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Certbot部署配置HTTPS及nginx报错解决</h1><div class="post-info">May 5, 2018</div><div class="post-content"><p><img src="https://cdn.linuxstory.org/wp-content/uploads/2016/11/lets-encrypt.png" alt="Let&#39;s Encrypt"></p>
<p><strong>EEF 电子前哨基金会</strong>、 <strong>Mozilla 基金会</strong>和<strong>美国密歇根大学</strong>成立了一个公益组织叫 ISRG （ Internet Security Research Group ），这个组织从 2015 年开始推出了 <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a> 免费证书,后来又有<strong>思科</strong>、 <strong>Akamai</strong> 加入，甚至连 <strong>Linux 基金会</strong>也加入了合作，这些大牌组织的加入保证了这个项目的可信度和可持续性。<a id="more"></a><br>而ISRG 的发起者 EFF （电子前哨基金会）为 Let’s Encrypt 项目发布了一个官方的客户端 Certbot ，利用它可以完全自动化的获取、部署和更新安全证书。</p>
<p><img src="https://certbot.eff.org/images/certbot-logo-1A.svg" alt="certbot"></p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p>先是按照<a href="https://certbot.eff.org" target="_blank" rel="external">官方文档</a>选择相应的系统和服务器,假如运行环境为<strong>CentOS 7</strong>,Web服务器是<strong>Nginx</strong>,安装代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ yum -y install yum-utils</div><div class="line">$ yum-config-manager --enable rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional</div></pre></td></tr></table></figure>
<p>接着下载Certbot</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo yum install certbot-nginx</div></pre></td></tr></table></figure>
<h2 id="Get-Started"><a href="#Get-Started" class="headerlink" title="Get Started"></a>Get Started</h2><p>安装写成后尝试申请和部署ssl证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo certbot --nginx</div></pre></td></tr></table></figure>
<p>运行报错，信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//log 文件记录错误</div><div class="line">Traceback (most recent call last):</div><div class="line">File &quot;/root/.local/share/letsencrypt/lib/python2.6/site-packages/certbot/plugins/disco.py&quot;, line 130, in prepare</div><div class="line">self._initialized.prepare()</div><div class="line">File &quot;/root/.local/share/letsencrypt/lib/python2.6/site-packages/certbot_nginx/configurator.py&quot;, line 155, in prepare</div><div class="line">raise errors.NoInstallationError</div><div class="line">NoInstallationError</div><div class="line">2017-07-15 14:25:35,535:DEBUG:certbot.plugins.selection:No candidate plugin</div><div class="line">2017-07-15 14:25:35,535:DEBUG:certbot.plugins.selection:Selected authenticator None and installer None</div></pre></td></tr></table></figure>
<p>发现是<strong>默认nginx配置路径</strong>和自己搭建的nginx目录不匹配，按照网友推荐的方式我也创建了快捷链接到目录中来解决问题，代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx</div><div class="line">ln -s /usr/local/nginx/conf/ /etc/nginx</div></pre></td></tr></table></figure>
<p>接着运行<code>sudo certbot --nginx</code>,再次错误，具体报错信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">UnicodeDecodeError: &apos;ascii&apos; codec can&apos;t decode byte 0xe2 in position 330: ordinal not in range(128)</div><div class="line">2017-11-12 15:15:18,560:ERROR:certbot.log:An unexpected error occurred:</div></pre></td></tr></table></figure>
<p>发现是字符编码解码的问题，一种解决方法为设置以utf-8编码运行代码，第二种就将nginx配置文件中的中文或其它非ascii编码替换成ascii编码（或者删除），我使用了第二种，将配置文件多余的中文去除，接着继续运行<code>sudo certbot --nginx</code>,选择好自己的域名，选择yse即可</p>
<h2 id="Automating-renewal"><a href="#Automating-renewal" class="headerlink" title="Automating renewal"></a>Automating renewal</h2><p>测试能否更新证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo certbot renew --dry-run</div></pre></td></tr></table></figure>
<p>如成功则添加定时任务<code>crontab -e</code>，内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 0,12 * * * python -c &apos;import random; import time; time.sleep(random.random() * 3600)&apos; &amp;&amp; certbot renew</div></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>从http更新到https很简单(自动化)，其它的做法也有去阿里云或七牛云配置https，根据不同需求选择自己的做法，以上在安装过程中发生的一个certbot中的nginx默认路径和配置文件编码问题供参考，具体代码配置跟着官方文档即可，希望你也能早日配置更安全的https网站,就酱。<br> (•ㅂ•)/♥  共勉~</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://certbot.eff.org" target="_blank" rel="external">Certbot-官方网站</a><br><a href="https://github.com/certbot/certbot/issues/4937" target="_blank" rel="external">Certbot-nginx-NoInstallationError-Github问题</a><br><a href="https://github.com/certbot/certbot/issues/5236" target="_blank" rel="external">Certbot-UnicodeDecodeError-Github问题</a><br><a href="https://linuxstory.org/deploy-lets-encrypt-ssl-certificate-with-certbot/" target="_blank" rel="external">HTTPS 简介及使用官方工具 Certbot 配置</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/20/PHP-Interview/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2018 <a href="https://areirei.github.io">FullStackMan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>